<!DOCTYPE html>
<html lang=en>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <title>u1-ico Test</title>

        <script src="https://cdn.jsdelivr.net/gh/nuxodin/lazyfill/mod.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/nuxodin/lazyfill/htmlfills.js"></script>

        <script src="../auto.js" type=module></script>

        <style>
        html {
            --u1-ico-dir:'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/icons/';
        }
        </style>

<body style="display:flex; flex-wrap:wrap;">

    <aside style="flex:1 1 auto; background:var(--color-light)">
        <nav style="position:sticky; top:0; bottom:0; height:100vh; padding:2rem; overflow:auto">
            <ul id=nav></ul>
        </nav>
    </aside>

    <main style="flex:199 1 auto">

        <section id=reposSec>
            <script type=module>
                import {dump} from 'https://cdn.jsdelivr.net/gh/nuxodin/dump.js@1.2.0/mod.min.js';

                const repos = await fetch('../repos.json').then(res=>res.json());
                const extToName = {
                    'el':'Elements',
                    'attr':'Attributes',
                    'js':'JavaScript',
                    'class':'Classes',
                    'css':'Stylesheets',
                };
                const typedRepos = {};
                for (const repo of repos) {
                    const ext = repo.name.match(/\.([^]+)$/)?.[1];
                    typedRepos[ext]??=[];
                    typedRepos[ext].push(repo);
                }
                // sort inside each group
                for (const [key, repos] of Object.entries(typedRepos)) {
                    typedRepos[key] = repos.sort((r1, r2)=>{
                        if(r1.name < r2.name) return -1;
                        if(r1.name > r2.name) return 1;
                        return 0;
                    });
                }

                //let str = '';
                let navStr = '';
                for (const [ext, entries] of Object.entries(typedRepos)) {
                    if (ext == 'undefined') continue;
                    navStr += `<h2>${extToName[ext]}</h2>`;

                    for (let repo of entries) {
                        let url = `https://github.com/u1ui/${repo.name}`;
                        //let release = repo.release_latest;
                        //let repoDate    = new Date(repo.pushed_at);
                        //let releaseDate = new Date(release.published_at);
                        //const masterNotPushed = repoDate > releaseDate

                        const localUrl = '../../' + repo.name;

                        //let exampleCodeUrl = `https://raw.githubusercontent.com/u1ui/${repo.name}/main/tests/minimal.html`;
                        let exampleCodeUrl = localUrl+`/tests/minimal.html`;


                        let parts = await fetch(exampleCodeUrl).then(res=>res.text()).then(html=>{
                            // parse the example code
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');

                            return {
                                html:doc.querySelector('section')?.innerHTML,
                                style:doc.querySelector('style')?.innerHTML,
                            }
                        });

                        if (ext === 'el') {
                            const tag = 'u1-'+repo.name.replace(/\.el$/,'');
                            parts.html ??= `<${tag}>Content</${tag}>`;
                            parts.style ??= `
                                ${tag} {
                                }`;
                        }
                        if (ext === 'attr') {
                            const attr = 'u1-'+repo.name.replace(/\.attr$/,'');
                            parts.html ??= `<div ${attr}>hello</div>`;
                            parts.style ??= `
                                [${attr}] {
                                }`;
                        }


                        /* */
                        const str =
                        `
                        <section style="max-width:40rem; margin:4rem auto; box-shadow:0 0 1rem #0005" id="repo_${repo.name}">
                            <h2 style="margin:0; padding:1rem; background-color:#f5f5f5; display:flex; justify-content:space-between;">
                                ${repo.name}
                                <a href="${url}" target=github><u1-ico inline>github</u1-ico></a>
                            </h2>
                            <div style="padding:2rem">
                                <figure class=demo style="position:relative; padding:1rem; box-shadow:none; overflow:auto; resize:both; border:1px solid #eee;">
                                    ${parts.html}
                                </figure>
                            </div>
                            <u1-tabs>
                                <h3>HTML</h3>
                                <u1-code trim editable oninput="this.closest('section').querySelector('.demo').innerHTML = this.value">
                                    <script type=x>
                                        ${parts.html}
                                    <\/script>
                                </u1-code>
                                <h3>CSS</h3>
                                <u1-code trim editable>
                                    <style>
                                        ${parts.style}
                                    </style>
                                </u1-code>
                                <h3>Javascript</h3>
                                <u1-code trim editable>
                                    <script type=x>
                                    <\/script>
                                </u1-code>
                                <h3>Events</h3>
                                <div class=-events style="overflow:auto; max-height:20rem">
                                </div>
                            </u1-tabs>
                        </section>
                        `;
                        const div = document.createElement('div');
                        div.innerHTML = str;

                        document.getElementById('repos').append(div);
                        div.addEventListener('u1-carousel.slide', e=>{
                            div.querySelector('.-events').insertAdjacentHTML('beforeend', `
                                <details class=event>
                                    <summary class=event-name>${e.type}</summary>
                                    <div class=event-value>${dump(e.detail, {depth:1, order:1, inherited:true})}</div>
                                </div>
                            `);
                        },true)
                        /* *

                        str +=
                        `
                        <div style="border-bottom:2px solid; padding:3rem" id="repo_${repo.name}">
                            <h2 style="margin-bottom:0">
                                ${repo.name}
                                <a href="${url}" target=github><u1-ico inline>github</u1-ico></a>
                            </h2>
                            <div style="margin-bottom:2rem">${repo.description??''}</div>

                            <label>
                                <input type=checkbox onclick="let iframe = this.parentNode.nextElementSibling; iframe[(this.checked?'set':'remove')+'Attribute']('sandbox',''); iframe.src=iframe.src+'?'">
                                disable javascript
                            </label>
                            <!--label>
                                <input type=checkbox onclick="let style = this.parentNode.nextElementSibling.contentWindow.document.documentElement.style; style.colorScheme = style.colorScheme==='dark'?'light':'dark'">
                                toggle theme
                            </label-->
                            <iframe loading=lazy src="${localUrl}/tests/test.html" style="height:39rem"></iframe>
                        </div>
                        `
                        /* */
                        navStr += `
                        <li>
                            <a href="#repo_${repo.name}">${repo.name}</a>
                        `
                    }
                }
                //document.getElementById('repos').innerHTML = str;
                document.getElementById('nav').innerHTML = navStr;
            </script>
            <div id=repos></div>
        </section>
    </main>